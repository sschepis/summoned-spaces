<!DOCTYPE html>
<html>
<head>
    <title>SSE Test for Summoned Spaces</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #0f0;
            padding: 20px;
        }
        .log {
            margin: 5px 0;
            padding: 5px;
            background: #000;
            border: 1px solid #0f0;
        }
        .error {
            color: #f00;
            border-color: #f00;
        }
        .success {
            color: #0f0;
            border-color: #0f0;
        }
        .info {
            color: #ff0;
            border-color: #ff0;
        }
    </style>
</head>
<body>
    <h1>SSE Connection Test for summoned-spaces.vercel.app</h1>
    <div id="logs"></div>
    
    <script>
        const logsDiv = document.getElementById('logs');
        
        function log(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(logEntry);
            console.log(message);
        }

        log('Starting SSE connection test...', 'info');
        
        // Test 1: Check if EventSource is available
        if (typeof EventSource === 'undefined') {
            log('‚ùå EventSource not supported in this browser', 'error');
        } else {
            log('‚úÖ EventSource is supported', 'success');
        }

        // Test 2: Try to connect to the SSE endpoint
        const sseUrl = 'https://summoned-spaces.vercel.app/api/events';
        log(`Attempting to connect to: ${sseUrl}`, 'info');
        
        try {
            const eventSource = new EventSource(sseUrl);
            
            eventSource.onopen = function() {
                log('‚úÖ SSE Connection OPENED!', 'success');
                log('Real-time updates are now active', 'success');
            };
            
            eventSource.onmessage = function(event) {
                log(`üì® Received message: ${event.data}`, 'success');
                try {
                    const message = JSON.parse(event.data);
                    log(`Message type: ${message.kind}`, 'info');
                    log(`Message payload: ${JSON.stringify(message.payload)}`, 'info');
                } catch (e) {
                    log(`Raw message: ${event.data}`, 'info');
                }
            };
            
            eventSource.onerror = function(error) {
                log('‚ùå SSE Connection ERROR', 'error');
                log(`ReadyState: ${eventSource.readyState}`, 'error');
                if (eventSource.readyState === EventSource.CONNECTING) {
                    log('üîÑ Attempting to reconnect...', 'info');
                } else if (eventSource.readyState === EventSource.CLOSED) {
                    log('‚ùå Connection closed', 'error');
                }
            };
            
            // Test 3: Check CORS by fetching the endpoint
            log('Testing CORS configuration...', 'info');
            fetch(sseUrl)
                .then(response => {
                    log(`CORS test response status: ${response.status}`, response.ok ? 'success' : 'error');
                    log(`Response headers:`, 'info');
                    response.headers.forEach((value, key) => {
                        log(`  ${key}: ${value}`, 'info');
                    });
                })
                .catch(error => {
                    log(`‚ùå CORS test failed: ${error.message}`, 'error');
                });
                
        } catch (error) {
            log(`‚ùå Failed to create EventSource: ${error.message}`, 'error');
        }
        
        // Test 4: Check if we can POST to messages endpoint
        setTimeout(() => {
            log('Testing /api/messages endpoint...', 'info');
            fetch('https://summoned-spaces.vercel.app/api/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    kind: 'test',
                    payload: { message: 'Testing SSE' }
                })
            })
            .then(response => {
                log(`/api/messages response: ${response.status}`, response.ok ? 'success' : 'error');
                return response.text();
            })
            .then(text => {
                log(`Response body: ${text}`, 'info');
            })
            .catch(error => {
                log(`‚ùå /api/messages test failed: ${error.message}`, 'error');
            });
        }, 2000);
    </script>
</body>
</html>